# LLMOps精度検証基盤 アーキテクチャ概要

## 概要
本システムはレイヤードアーキテクチャ（層状アーキテクチャ）とドメイン駆動設計（DDD）の原則に基づいて構築されています。

## レイヤー構成

### 1. インターフェース層（Interfaces Layer）
**責務**: 外部とのやり取りを管理
- FastAPIエンドポイントの定義
- リクエスト/レスポンスの変換
- 入力値の基本的なバリデーション

**依存**: アプリケーション層のみに依存

### 2. アプリケーション層（Application Layer）
**責務**: ビジネスユースケースの調整
- ユースケースの実装（実験実行、文書抽出など）
- トランザクション管理
- ドメイン層のサービスやモデルの調整

**依存**: ドメイン層に依存

### 3. ドメイン層（Domain Layer）
**責務**: ビジネスロジックとルールの実装
- ドメインモデル（Experiment、ExtractionResult、AccuracyMetric）
- ドメインサービス（精度評価、実験管理）
- リポジトリインターフェース（実装はインフラ層）

**依存**: 他の層に依存しない（最も重要）

### 4. インフラストラクチャ層（Infrastructure Layer）
**責務**: 技術的な詳細の実装
- 外部サービスとの連携（Langfuse、Gemini API）
- データの永続化（ファイルシステム、データベース）
- リポジトリインターフェースの具体的な実装

**依存**: ドメイン層とアプリケーション層に依存

## 依存関係のルール

```
Interfaces → Application → Domain
     ↓           ↓           ↑
     └─────→ Infrastructure ─┘
```

- 上位層は下位層に依存してもよい
- 下位層は上位層に依存してはいけない
- ドメイン層は他の層に依存しない（純粋なビジネスロジック）

## プロジェクト構成

```
llmops/
├── src/
│   ├── domain/              # ドメイン層
│   │   ├── models/          # エンティティ・値オブジェクト
│   │   ├── repositories/    # リポジトリインターフェース
│   │   └── services/        # ドメインサービス
│   │
│   ├── application/         # アプリケーション層
│   │   ├── use_cases/       # ユースケース実装
│   │   └── dto/             # データ転送オブジェクト
│   │
│   ├── infrastructure/      # インフラストラクチャ層
│   │   ├── langfuse/        # Langfuse連携実装
│   │   ├── gemini/          # Gemini API連携実装
│   │   ├── repositories/    # リポジトリ実装
│   │   └── config/          # 設定管理
│   │
│   └── interfaces/          # インターフェース層
│       ├── api/             # FastAPIエンドポイント
│       └── schemas/         # リクエスト/レスポンススキーマ
│
├── tests/                   # テストコード（同じ層構造）
└── docs/                    # ドキュメント（同じ層構造）
```

## 主な利点

1. **テスタビリティ**: 各層が独立しているため、モックを使った単体テストが容易
2. **保守性**: ビジネスロジックと技術的詳細が分離されている
3. **拡張性**: 新機能追加時の影響範囲が明確
4. **理解しやすさ**: 各層の責務が明確で、AIツールも適切な実装場所を判断しやすい

## 実装時の注意点

1. **ドメイン層の純粋性を保つ**
   - フレームワーク固有のコードを含めない
   - 外部ライブラリへの直接依存を避ける

2. **依存性注入の活用**
   - インターフェースを通じて依存関係を注入
   - テスト時のモック差し替えを容易にする

3. **DTOの活用**
   - 層間のデータ受け渡しにはDTOを使用
   - ドメインモデルを直接露出させない